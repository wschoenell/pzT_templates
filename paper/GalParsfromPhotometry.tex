%% LyX 2.1.1 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[english]{article}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{babel}
\begin{document}

\title{FITTING SYNTHETIC LIBRARIES TO PHOTOMETRIC DATA}

\maketitle

\section*{Posing the problem}

Let's assume that we have an empirically calibrated template library
$T_{i}$ with $i=1,n_{T}$ in a redshift grid $z_{j}$ where $z_{j}=z_{1}+(j-1)dz$,
$j=1,n_{z}$ . We also have a synthetic library $S_{k}$ with $k=1,n_{S}$,
where, generally speaking, $n_{S}>>n_{T}$ . The problem at hand is
to calculate $p(S_{k}|\mathbf{C,}m_{0},I),$where $\mathbf{C}=\mathbf{m}-m_{0}$
are the colors of a galaxy and $m_{0}$ is the magnitude we use to
define the redshift/magnitude prior. $S_{k}$ can be very large and
may contain many spectral types which are not realistic, in the sense
of not being present in the galaxy population. It is therefore not
practical to calculate directly these probability, using e.g. BPZ
or other similar codes since the color/redshifts degenaracies will
be much worse than for a compact, well-calibrated empirical library.
We therefore try to solve the problem by forcing the solutions to
belong to the color space defined by the empirical templates and the
magnitude/redshift prior $p(z,T|m_{0})$. And so:$ $

\begin{equation}
p(S_{k},z_{i}|\mathbf{C},m_{0})=\sum_{j=1}^{n_{T}}p(S_{k},z_{i},T_{j}|\
mathbf{C},m_{0})=\sum_{j=1}^{n_{T}}p(z_{i},T_{j}|\mathbf{C},m_{0})p(S_{k
}|z_{i},T_{j},\mathbf{C},m_{0})
\end{equation}


Since the probability of having the $S_{k}$ template is completely
determined by its comparison with the $T_{j}$ template, we can write:

\begin{equation}
p(S_{k}|z_{i},T_{j},\mathbf{C},m_{0})=p(S_{k}|z_{i},T_{j})\propto p_{I}(S_{k})p(T_{j}|S_{k},z_{i})
\end{equation}


The factor $p_{I}(S_{k})$ is a prior for the synthetic template library.
For instance when we produce the library we may want to assign equal
weight to all metallicities, etc. It can be flat, or we can use it
to modulate the parameter estimation. The factor $ $$p(z_{i},T_{j}|\mathbf{C},m_{0},I)$
is the posterior generated by BPZ. The factor $p(T_{j}|z_{i},S_{k})$
can be calculated as 
\[
p(T_{j}|z_{i},S_{k})\propto\exp(-\chi2/2)
\]


where 
\[
\chi^{2}(S_{k};z_{i},T_{j})=\sum_{\alpha}[S_{k\alpha}(z_{i})-T_{j\alpha}(z_{i})]^{2}
\]


where $S_{k\alpha}$ and $T_{j\alpha}$ are, respectively, the fluxes
of the templates $S_{k}$ and $T_{j}$, redshifted to $z_{i}$ observed
with the filter $\alpha$, and the sum goes over all the observed
$n_{F}$ filters. We can calculate this expression using a formula
similar to that in Benítez 2000. If we define 

\[
s_{S_{k}T_{j}}=\sum_{\alpha}S_{k\alpha}T_{j\alpha};\; s_{S_{k}}=\sum_{\alpha}S_{k\alpha}^{2};\; s_{T_{j}}=\sum_{\alpha}T_{j\alpha}^{2}
\]


then we have 

\[
\chi^{2}(S_{k};z_{i},T_{j})=s_{S_{k}}(z_{i})-\frac{s_{S_{k}T_{j}}^{2}(z_{i})}{s_{T_{j}}(z_{i})}
\]


The factor $ $$p(S_{k}|z_{i},T_{j})$ is a data cube of $n_{S}\times n_{z}\times n_{T}$
size, but it has to be calculated only once. Moreover, we can greatly
reduce the size of this array by culling those values of $k$ for
which the maximum of $p(S_{k}|z_{i},T_{j})$ is very small and shrinking
the first axis of the data cube to $n'_{S}<<n_{S}$. Calculating $p(S_{k}|z_{i},T_{j},\mathbf{C},m_{0})$
for each galaxy is thus reduced to multiplying the BPZ posterior,
$p(z_{i},T_{j}|\mathbf{C},m_{0})$, by the $ $$p(S_{k}|z_{i},T_{j})$
array (and we can use python fancy indexing to operate only on those
values for which $p(z_{i},T_{j}|\mathbf{C},m_{0})>\epsilon$, further
reducing the number of calculations involved) and then averaging over
the $T_{j}$ axis. That would yield the $n_{S}\times n_{z}$ array
$p(S_{k},z_{i}|\mathbf{C},m_{0})$.


\section*{Galaxy parameters}

To calculate the probability of any parameter $\theta_{S}$ characterizing
the spectra, where $\theta_{S}$ can be a scalar, like the luminosity
$L$ , the stellar mass $M_{\star}$, and the metallicity $Z$, or
multivalued, as the SFH, we have: 

\[
p(\theta_{S},z_{i}|\mathbf{C},m_{0})=\sum_{k=1}^{n_{S}}p(S_{k},\theta_{S},z_{i}|\mathbf{C},m_{0})=\sum_{k}p(S_{k},z_{i}|\mathbf{C},m_{0})p(\theta_{S}|S_{k},z_{i},\mathbf{C},m_{0})]=
\]


\[
=\sum_{k}p(S_{k},z_{i}|\mathbf{C},m_{0},I)\delta[\theta_{S}(S_{k},z_{i},m_{0})]
\]


where $\delta$ is the delta function, and we have taken into account
that, generally speaking, $\theta$ will be fully determined by $S_{k},m_{0}$
and $z_{i}$. 

Thus, to calculate the galaxy parameters, one has first to find the
analytical or numerical relationship 

$\theta=\theta(S_{k},z_{i},m_{0})$

In same cases, e.g. the metallicity, it is not necessary to use the
redshift and magnitude. In others, e.g. the luminosity, SFR or the
stellar mass that information will be relevant. 

It is important here to take into account the prior $p_{I}(S_{k})$
if the initial library $S_{k}$ is not randomly distributed in the
parameter space. 

The resulting function will yield disjoint point estimates of $p(\theta_{S})$,
to calculate the final distribution of $\theta_{S}$ at each redshift,
we have to bin in $\delta\theta$ intervals and integrate. 
\end{document}
